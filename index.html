<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<!-- bsv cdn unpkg -->
		<script src="https://unpkg.com/bsv@1.5"></script>
		<!-- qrious cdn -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
		<title>BSV Locking & Redeem Scripts</title>
		<!-- favicon -->
		<link rel="icon" href="./logo.png" />
		<!-- twitter card -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@_codenlighten" />
		<meta name="twitter:creator" content="@_codenlighten" />
		<meta name="twitter:title" content="BSV Locking & Redeem Scripts" />
		<meta
			name="twitter:description"
			content="Generate BSV locking and redeem scripts for secret phrase locks"
		/>
		<meta
			name="twitter:image"
			content="https://plugins.whatsonchain.com/api/plugin/main/0dc5e48442a408d0961bb33758ab22d84820830878370dc857e852fa611d79b3"
		/>

		<!-- montserrat -->
		<link
			href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
			rel="stylesheet"
		/>
		<!-- style -->
		<style>
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			body {
				font-family: "Montserrat", sans-serif;
				background-color: #f5f5f5;
				word-wrap: break-word;
			}
			.container {
				max-width: 800px;
				margin: 0 auto;
				padding: 1rem;
				text-align: center;
			}

			#header h1 {
				margin: 1rem auto;
				font-size: 1.5rem;
			}
			.address {
				text-align: center;
				margin: auto;
			}
			.address__qrcode {
				margin: 1rem auto;
			}
			.address__text {
				margin-bottom: 1rem;
			}
			.address__balance {
				margin-bottom: 1rem;
			}
			.commonLocks__item {
				display: flex;
				flex-direction: column;
			}
			.commonLocks__item {
				margin-bottom: 1rem;
			}
			.commonLocks__item h3 {
				margin-bottom: 0.5rem;
			}
			.commonLocks__item p {
				margin-bottom: 0.5rem;
			}
			.commonLocks__item input {
				margin-bottom: 0.5rem;
			}
			.commonLocks__item button {
				margin-bottom: 0.5rem;
			}

			body {
				word-wrap: break-word;
			}
			#redeemLock {
				margin-top: 1rem;
			}

			#logo {
				width: 100%;
				max-width: 400px;
				margin-bottom: 1rem;
			}

			#broadcast {
				margin-bottom: 1rem;
			}
			#broadcastRedeemTx {
				margin-bottom: 1rem;
			}
			input {
				padding: 0.5rem;
				border-radius: 0.5rem;
				border: 1px solid #ccc;
				margin-bottom: 1rem;
			}
			button {
				padding: 0.5rem;
				border-radius: 0.5rem;
				border: 1px solid #ccc;
				margin-bottom: 1rem;
				cursor: pointer;
			}

			@media (min-width: 768px) {
				.container {
					padding: 2rem;
				}
				#header h1 {
					margin: 1rem auto;
					font-size: 1.5rem;
				}
				.address {
					text-align: center;
					margin: auto;
				}
				.address__qrcode {
					margin: 1rem auto;
				}
				.address__text {
					margin-bottom: 1rem;
				}
				.address__balance {
					margin-bottom: 1rem;
				}
			}
		</style>
	</head>
	<body>
		<div class="container" id="header">
			<img
				id="logo"
				src="https://plugins.whatsonchain.com/api/plugin/main/45d98d1321fa2b3e8125a32a85c1df9339eb62233cdc2f1985ea6826eeb6f48a"
				alt=""
			/>
			<h1>BSV Locking & Redeem Scripts</h1>
			<div class="address">
				<div class="address__qrcode">
					<!-- canvas -->
				</div>
				<div class="address__text"></div>
				<div class="address__balance"></div>
			</div>
		</div>
		<div class="container" id="commonLocks">
			<h2>Secret Password Locking Scripts</h2>

			<!-- secret phrase -->
			<div class="commonLocks__item">
				<h3>Generate a Hash Lock</h3>
				<label for="">Add Your Secret Below</label>
				<!-- input for secret -->
				<input type="password" id="secret" placeholder="secret" />
				<!-- input for amount -->
				<input type="number" id="amount" placeholder="amount" />
				<!-- button to generate locking script -->
				<!-- add message -->
				<label for="">Add a Message</label>
				<input id="message" type="text" value="NFTYLocks" />
				<button id="generateLockingScript">Generate Locking Script</button>
				<!-- locking script -->
				<p id="lockingScriptHex"></p>
				<!-- asm -->
				<p id="lockingScriptAsm"></p>
				<button id="broadcast">Broadcast</button>
				<p id="txid"></p>
			</div>
			<div class="commonLocks__item">
				<h1>Redeem a Lock</h1>
				<!-- input for transaction id -->
				<input type="text" id="transactionId" placeholder="transaction id" />
				<!-- input for secret -->
				<input type="password" id="redeemSecret" placeholder="secret" />
				<!-- receiver address -->
				<input
					type="text"
					id="receiverAddress"
					placeholder="receiver address"
				/>
				<!-- button to generate unlocking script -->
				<button id="generateUnlockingScript">Generate Unlocking Script</button>
				<!-- unlocking script -->
				<p id="unlockingScriptHex"></p>
				<!-- asm -->
				<p id="unlockingScriptAsm"></p>
				<button id="broadcastRedeemTx">Broadcast</button>
				<p id="txid2"></p>
			</div>
			<div class="commonLocks_item">
				<h1>Send BSV</h1>
				<label for="">Recipient's Address</label>
				<input
					type="text"
					id="receiverAddress2"
					placeholder="receiver address"
				/>
				<label for="">Amount</label>
				<input type="number" id="amount2" placeholder="amount" />
				<button id="sendBsv">Send BSV</button>
				<p id="txid3"></p>
			</div>
		</div>
		<script>
			const Buffer = bsv.deps.Buffer;
			const hash = bsv.crypto.Hash;
			const sha256 = (buffer) => hash.sha256(buffer);
			const createQrCode = (text) => {
				const canvas = document.createElement("canvas");
				const qr = new QRious({
					element: canvas,
					value: text,
					size: 200,
				});
				document.querySelector(".address__qrcode").appendChild(canvas);
			};

			const broadcast = async (tx) => {
				const url = "https://api.whatsonchain.com/v1/bsv/main/tx/raw";
				const res = await fetch(url, {
					method: "POST",
					body: JSON.stringify({ txhex: tx }),
				});
				const json = await res.json();
				return json;
			};

			const generateKeys = () => {
				const privateKey = new bsv.PrivateKey();
				const publicKey = bsv.PublicKey.fromPrivateKey(privateKey);
				const address = bsv.Address.fromPublicKey(publicKey);
				return {
					privateKey: privateKey.toString(),
					publicKey: publicKey.toString(),
					address: address.toString(),
				};
			};
			// onload check if localstorage has keys
			document.addEventListener("DOMContentLoaded", async () => {
				let keys = localStorage.getItem("keys");
				let address;
				if (!localStorage.getItem("keys")) {
					keys = generateKeys();
					localStorage.setItem("keys", JSON.stringify(keys));
				}
				keys = JSON.parse(localStorage.getItem("keys"));
				const { privateKey } = keys;
				address = keys.address;
				document.querySelector(".address__text").innerHTML = address;
				await createQrCode(address);
				const balance = await getBalance(address);
				document.querySelector(
					".address__balance"
				).innerHTML = `Balance: ${balance} sats`;
				// add address to receiver address
				document.getElementById("receiverAddress").value = address;
			});

			const getUtxos = async (address) => {
				// whatsonchain
				const url = `https://api.whatsonchain.com/v1/bsv/main/address/${address}/unspent`;
				const res = await fetch(url);
				const json = await res.json();
				const utxos = [];
				json.forEach((utxo) => {
					utxos.push({
						txid: utxo.tx_hash,
						vout: utxo.tx_pos,
						script: bsv.Script.buildPublicKeyHashOut(address).toHex(),
						satoshis: utxo.value,
					});
				});
				return utxos;
			};
			const getBalance = async (address) => {
				// whatsonchain
				const url = `https://api.whatsonchain.com/v1/bsv/main/address/${address}/balance`;
				const res = await fetch(url);
				const json = await res.json();
				const balance = json.confirmed + json.unconfirmed;
				return balance;
			};
			const getTx = async (txid) => {
				// whatsonchain
				const url = `https://api.whatsonchain.com/v1/bsv/main/tx/hash/${txid}`;
				const res = await fetch(url);
				const json = await res.json();
				return json;
			};

			const buildHashLock = async (
				address,
				privateKey,
				secret,
				message,
				amount
			) => {
				let utxos = await getUtxos(address);
				// convert to whatsonchain format
				// utxos = utxos.filter((utxo) => utxo.satoshis > amount);
				const totalSats = utxos.reduce((acc, utxo) => acc + utxo.satoshis, 0);
				console.log(utxos);
				const tx = new bsv.Transaction();
				tx.from(utxos);
				// create sha256 hash of secret
				console.log(secret);
				const hash = sha256(Buffer.from(secret));
				console.log(hash.toString("hex"));
				const secretHash = sha256(hash).toString("hex");
				console.log(secretHash.toString("hex"));
				const lock = new bsv.Script.empty()
					.add(bsv.Opcode.OP_SHA256)
					.add(Buffer.from(secretHash, "hex"))
					.add(bsv.Opcode.OP_EQUAL)
					.add(bsv.Opcode.OP_RETURN)
					.add(Buffer.from(message));
				// add message

				console.log(amount);
				tx.addOutput(
					new bsv.Transaction.Output({
						script: lock,
						satoshis: parseInt(amount),
					})
				);
				tx.feePerKb(50);
				tx.change(address);
				tx.sign(privateKey);
				// console.log(tx.outputs[0].script.toHex());
				console.log("Tx", tx.toString());
				// console log script in asm
				// console.log(tx.outputs[0].script.toASM());
				return tx;
			};
			const buildHashUnlockingStack = async (
				txinfo,
				secret,
				receiverAddress
			) => {
				const secretHash = sha256(Buffer.from(secret)).toString("hex");
				console.log(secretHash);
				// const utxo = txinfo.vout[0];
				const nonstandardOutputs = txinfo.vout.filter(
					(output) => output.scriptPubKey.type === "nonstandard"
				);
				const utxo = nonstandardOutputs[0];
				console.log(nonstandardOutputs);
				const script = bsv.Script.fromHex(utxo.scriptPubKey.hex);
				const sats = Math.floor(utxo.value * 100000000);
				console.log(sats);
				// additional funding input
				// const additionalUtxos = await getUtxos(receiverAddress);

				const unlockingScript = new bsv.Script().add(
					// secret hash
					Buffer.from(secretHash, "hex")
				);
				// .add(Buffer.from(secretHash, "hex"));
				const tx = new bsv.Transaction();
				tx.feePerKb(50);
				tx.from({
					txid: txinfo.txid,
					vout: 0,
					script: script,
					satoshis: sats,
				});
				const estFee = tx._estimateFee();
				tx.to(receiverAddress, sats - estFee);
				// add additional funding inputs
				// tx.from(additionalUtxos);
				// tx.change(utxoFunding);
				tx.inputs[0].setScript(unlockingScript);
				console.log(tx.uncheckedSerialize());
				return tx;
			};

			const generateLockingScriptBtn = document.getElementById(
				"generateLockingScript"
			);
			generateLockingScriptBtn.addEventListener("click", async () => {
				const keys = JSON.parse(localStorage.getItem("keys"));
				const { privateKey, address } = keys;
				const amount = document.getElementById("amount").value;
				const secret = document.getElementById("secret").value;
				const message = document.getElementById("message").value;
				const tx = await buildHashLock(
					address,
					privateKey,
					secret,
					message,
					amount
				);
				document.getElementById("lockingScriptHex").innerHTML =
					tx.toString("hex");
				document.getElementById(
					"lockingScriptAsm"
				).innerHTML = `<p>ASM: ${tx.outputs[0].script.toASM()}</p>`;
			});
			const generateUnlockingScriptBtn = document.getElementById(
				"generateUnlockingScript"
			);
			generateUnlockingScriptBtn.addEventListener("click", async () => {
				const secret = document.getElementById("redeemSecret").value;
				const txid = document.getElementById("transactionId").value;
				const receiverAddress =
					document.getElementById("receiverAddress").value;
				const tx = await getTx(txid);
				console.log(tx);
				const unlockingScript = await buildHashUnlockingStack(
					tx,
					secret,
					receiverAddress
				);
				document.getElementById("unlockingScriptHex").innerHTML =
					unlockingScript.toString("hex");
				document.getElementById(
					"unlockingScriptAsm"
				).innerHTML = `<p>ASM: ${unlockingScript.inputs[0].script.toASM()}</p>`;
			});

			const broadcastBtn = document.getElementById("broadcast");
			broadcastBtn.addEventListener("click", async () => {
				const tx = document.getElementById("lockingScriptHex").innerHTML;
				console.log(tx);
				const res = await broadcast(tx);
				document.getElementById(
					"txid"
				).innerHTML = `<a href="https://whatsonchain.com/tx/${res}" target="_blank">${res}</a>`;
			});

			const broadcastRedeemTxBtn = document.getElementById("broadcastRedeemTx");
			broadcastRedeemTxBtn.addEventListener("click", async () => {
				const tx = document.getElementById("unlockingScriptHex").innerHTML;
				const res = await broadcast(tx);
				document.getElementById(
					"txid2"
				).innerHTML = `<a href="https://whatsonchain.com/tx/${res}" target="_blank">${res}</a>`;
			});

			const sendBsvBtn = document.getElementById("sendBsv");
			sendBsvBtn.addEventListener("click", async () => {
				const keys = JSON.parse(localStorage.getItem("keys"));
				const { privateKey, address } = keys;
				const receiverAddress =
					document.getElementById("receiverAddress2").value;
				const amount = document.getElementById("amount2").value;
				let utxos = await getUtxos(address);
				// convert to whatsonchain format
				utxos = utxos.filter((utxo) => utxo.satoshis > amount);
				const totalSats = utxos.reduce((acc, utxo) => acc + utxo.satoshis, 0);
				console.log(utxos);
				const tx = new bsv.Transaction();
				tx.from(utxos);
				tx.to(receiverAddress, amount);
				tx.feePerKb(50);
				tx.change(address);
				tx.sign(privateKey);
				console.log(tx.toString());
				if (!confirm("Are you sure you want to send this transaction?")) return;

				const res = await broadcast(tx.toString());
				document.getElementById(
					"txid3"
				).innerHTML = `<a href="https://whatsonchain.com/tx/${res}" target="_blank">${res}</a>`;
			});

			// check url params for txid ,  secret, and receiver address
			const urlParams = new URLSearchParams(window.location.search);
			const txid = urlParams.get("txid");
			const secret = urlParams.get("secret");
			const receiver = urlParams.get("address");
			const checkParams = async () => {
				if (txid || secret || receiverAddress) {
					document.getElementById("transactionId").value = txid || "";
					document.getElementById("redeemSecret").value = secret || "";
					document.getElementById("receiverAddress").value = receiver || "";
					let tx;
					if (txid) {
						tx = await getTx(txid);
					}
					let unlockingScript;
					if (tx && secret && receiver) {
						unlockingScript = await buildHashUnlockingStack(
							tx,
							secret,
							receiver
						);
						document.getElementById("unlockingScriptHex").innerHTML =
							unlockingScript.toString("hex");
						document.getElementById("unlockingScriptAsm").innerHTML =
							unlockingScript.inputs[0].script.toASM();
					}
				}
			};
			checkParams();
		</script>
	</body>
</html>
